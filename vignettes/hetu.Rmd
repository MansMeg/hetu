---
title: "Finnish personal ID number data toolkit for R (hetu)"
author: "Pyry Kantanen, Jussi Paananen, Mans Magnusson, Leo Lahti"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
  rmarkdown::md_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Finnish personal ID number data toolkit for R (hetu)}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The **hetu R package** provides tools to work with Finnish personal identity numbers.

Where possible, we have unified the syntax with [sweidnumbr](https://github.com/rOpenGov/sweidnumbr).



## Installation

Install the current devel version in R:

```{r install, eval=FALSE}
devtools::install_github("ropengov/hetu")
```

Test the installation by loading the library:

```{r test, message=FALSE, warning=FALSE, eval=TRUE}
library(hetu)
```

We also recommend setting the UTF-8 encoding:

```{r locale, eval=FALSE}
Sys.setlocale(locale="UTF-8") 
```

## Introduction

Finnish personal identification numbers (Finnish: henkilötunnus, hetu in short), are used to identify citizens. Hetu PIN consists of eleven characters: DDMMYYCZZZQ, where DDMMYY is the day, month and year of birth, C is the century marker, ZZZ is the individual number and Q is the control character. 

Males have odd and females have even individual number. The control character is determined by dividing DDMMYYZZZ by 31 and using the remainder (modulo 31) to pick up the corresponding character from the string "0123456789ABCDEFHJKLMNPRSTUVWXY". For example, if the remainder is 0, the control character is 0 and if the remainder is 12, the control character is C.

A valid individual number is between 002-899. Individual numbers 900-999 are not in normal use and are used only for temporary or artificial PINs. These temporary PINs are sometimes used in different organizations, such as insurance companies or hospitals, if the individual is not a Finnish citizen, a permanent resident or if the exact identity of the individual cannot be determined at the time. Artificial or temporary PINs are not intended for continuous, long term use and they are not usually accepted by PIN validity checking algorithms.

Temporary PINs provide similar information about individual's birth date or sex as regular PINs. Temporary PINs can also be safely used for testing purposes, as such a number cannot be linked to any real person.

## Personal identification number (HETU)

The basic hetu function can be used to view information from a Finnish personal identification number. The data is outputted as a data frame.

```{r hetu_example1, message=FALSE}
example_pin <- "111111-111C"
hetu(example_pin)
```

The output can be made prettier, for example by using knitr:

```{r hetu_example2, message=FALSE}
knitr::kable(hetu(example_pin))
```

The hetu function also accepts vectors with several identification numbers as input:

```{r hetu_example3, message=FALSE}
example_pins <- c("010101-0101", "111111-111C")
knitr::kable(hetu(example_pins))
```

The hetu function prints warning messages to the user if input vector contains invalid PINs.

```{r hetu_example4, error = TRUE, purl = FALSE}
hetu(c("010101-0102", "111311-111C", "010101-0101"))
```

The validity of the PINs can also be determined by using the hetu_ctrl function:

```{r hetu_ctrl_example1, fig.message=FALSE}
hetu_ctrl("010101-0101") # TRUE/FALSE 
hetu_ctrl("010101-1010") # FALSE
```

### Extracting specific information

Information contained in the PIN can be extracted with a generic extract parameter. Valid values for extraction are *hetu*, *sex*, *personal.number*, *checksum*, *date*, *day*, *month*, *year*, *century* and *is.temp*.

```{r hetuextract1, message=FALSE}
hetu(example_pins, extract = "sex")
hetu(example_pins, extract = "checksum")
```

Some fields can be extracted with specialized functions. Extracting sex with hetu_sex function:

```{r hetuextract2, message=FALSE, eval=TRUE}
hetu_sex(example_pins)
```

Extracting age at current date and at a given date with hetu_age function:

```{r hetuextract3, message=FALSE, eval=TRUE}
hetu_age(example_pins)
hetu_age(example_pins, date = "2012-01-01")
```

Dates (birth dates) also have their own function, hetu_date.

```{r hetuextract4, message=FALSE, eval=TRUE}
hetu_date(example_pins)
```

### Artificial and temporary personal identification numbers

The package functions can be made to accept artificial or temporary personal identification numbers.Artificial and temporary PINs can be used normally by allowing them through allow.temp parameter.

```{r hetu_temp1, message=FALSE}
example_temp_pin <- "010101A900R"
knitr::kable(hetu(example_temp_pin, allow.temp = TRUE))
```

A vector with regular and temporary PINs mixed together prints only regular PINs, if allow.temp is not set to TRUE. Automatic omitting of temporary PINs does not produce a visible error message and therefore users need to be cautious if they want to use temporary PINs.

If temporary PINs are not explicitly allowed and the input vector consists of temporary PINs only, the function will return an error.

```{r hetu_temp2, error = TRUE, purl = FALSE}
example_temp_pins <- c("010101A900R", "010101-0101")
knitr::kable(hetu(example_temp_pins))
```

When allow.temp is set to TRUE, all PINs are handled as if they were regular PINs.

```{r hetu_temp3, message=FALSE}
knitr::kable(hetu(example_temp_pins, allow.temp = TRUE))
```

Validation function hetu_ctrl produces a FALSE for every artificial / temporary PIN, if they are not explicitly allowed.

```{r hetu_temp4, error = TRUE, purl = FALSE}
knitr::kable(hetu(example_temp_pins)) #FALSE TRUE
knitr::kable(hetu(example_temp_pins, allow.temp = TRUE)) #TRUE TRUE
```

## Generating random PINs

Random PINs can be generated by using the rpin function.

```{r rpin, message=FALSE}
rhetu(n = 4)
rhetu(n = 4, start_date = "1990-01-01", end_date = "2005-01-01")
```

The number of males in the generated sample can be changed with parameter p.male. Default is 0.4.

```{r rpin2, message=FALSE}
random_sample <- rhetu(n = 4, p.male = 0.8)
table(random_sample)
```

The default proportion of artificial / temporary PINs is 0.0, meaning that no artificial / temporary PINs are generated by default.

```{r rpin3, message=FALSE}
temp_sample <- rhetu(n = 4, p.temp = 0.5)
table(hetu(temp_sample, allow.temp = TRUE, extract = "is.temp"))
```

## Diagnostics

In addition to information mentioned in the section [Extracting specific information](#extracting-specific-information), the user can choose to print additional columns containing information about checks done on PINs. The diagnostic checks produce a TRUE or FALSE for the following categories: *valid.personal.number*, *valid.checksum*, *correct.checksum*, *valid.date*, *valid.day*, *valid.month*, *valid.length* and *valid.century*, FALSE meaning that hetu is somehow incorrect.

```{r example_diagnostics1, error = TRUE, purl = FALSE, warning = FALSE}
diagnosis_example <- c("010101-0102", "111111-111Q", 
"010101B0101", "320101-0101", "011301-0101", 
"010101-01010", "010101-0011")
head(hetu(diagnosis_example, diagnostic = TRUE), 3)
```

Diagnostic information can be examined more closely by using subset or by using a separate hetu_diagnostics function. The user can print all diagnostic information for all PINs in the dataset:

```{r example_diagnostics2, error = TRUE, purl = FALSE, warning = FALSE}
head(hetu_diagnostic(diagnosis_example), 3)
```

By using extract, the user can limit the printed columns to only those which have TRUE values.

```{r example_diagnostics3, error = TRUE, purl = FALSE, warning = FALSE}
hetu_diagnostic(diagnosis_example, extract = c("valid.century", "correct.checksum"))
```

When subsetting is set to TRUE, the function prints only rows with TRUE value in the extracted test.

```{r example_diagnostics4, error = TRUE, purl = FALSE, warning = FALSE}
hetu_diagnostic(diagnosis_example, subsetting = TRUE, extract = "valid.century")
```

## Various examples

A simple example on how to use hetu package in tidyverse/dplyr manner to extract information to tibble format.

```{r hetu_tibbles, eval = FALSE}
library(hetu)
library(tidyverse)
library(dplyr)

# Generate data for this example
hdat<-tibble(pin=rhetu(n = 4, start_date = "1990-01-01", end_date = "2005-01-01"))

# Extract all the hetu information to tibble format
hdat<-hdat %>%
  mutate(result=map(.x=pin,.f=hetu::hetu)) %>% unnest(cols=c(result))
hdat
```

```{r example2, message=FALSE, echo=FALSE, eval=FALSE}
# sweidnumbr additionally has class structure for IDs
#example_pin <- as.pin(example_pin)
#example_pin

#The next step is to test if the vector is a ```pin``` object. To do
#this we use the ```is.pin()``` function.
#is.pin(example_pin)

#This only check the format of the pin. To check the pin using the
#control number we use ```hetu_ctrl()```.
# hetu_ctrl(example_pin)

#It is also possible to format the pin for presentation in different forms. (Note however that #the output of `format_pin` is just a character and no longer a `pin` object):

#format_pin(example_pin, "%Y-%m-%d-%N")
#format_pin(example_pin, "%P")

#Sometimes we want some example `pin`s. We can easily simulate `pin`s using `rpin()`:
#rpin(3)

```



## Licensing and Citations

This work can be freely used, modified and distributed under the open license specified in the [DESCRIPTION file](https://github.com/rOpenGov/hetu/blob/master/DESCRIPTION).

Kindly cite the work as follows

```{r citation, message=FALSE, eval=TRUE}
citation("hetu")
```

## References

- [The personal identity code](https://dvv.fi/en/personal-identity-code). Digital and population data services agency.
- [Valtioneuvoston asetus väestötietojärjestelmästä (128/2010)](https://www.finlex.fi/fi/laki/ajantasa/2010/20100128) (In Finnish). Valtiovarainministeriö.
- [HETU-uudistuksen loppuraportti](http://urn.fi/URN:ISBN:978-952-367-296-3) (In Finnish. Valtiovarainministeriön julkaisuja 2020:20.

## Session info

This vignette was created with

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```

